# 计算机网络



# HTTP 协议

## 概念和特性

### 作用和应用



### 通信的过程



### 无状态协议



### 请求的方法



### 持久化连接



## 报文的信息



### 报文组成结构



### 编码加快传输



### 多部分对象集合



### 部分内容的范围请求



### 内容协商合适的内容



## 响应状态码



### 2XX 成功



### 3XX 重定向



### 4XX 客户端错误



### 5XX 服务端错误



## 报文首部字段



## 安全的 HTTPS





# 计算机网络

计算机网络由若干结点和连接这些结点的链路组成。结点可以是计算机、路由器、交换机等，与网络相连的计算机常称为主机。

不同的网络可以通过路由器互连起来，构成一个范围更大的计算机网络。这样的网络称为互连网 internet，全球最大的互连网称为互联网 Internet。

互联网具有两个基本特点：连通性、共享。连通指使用互联网的用户不管相距多远，都能非常快捷地进行通信，好像这些用户终端都是彼此直接连通一样。共享即是资源共享，用户终端可以快速访问远程主机存储的数据。

## 互联网的组成

从工作方式的角度，可以将互联网的拓扑结构分为两个部分：

* 边缘部分：由所有连接在互联网的主机组成，这部分是用户直接使用的，用来进行通信和资源共享。

* 核心部分：由大量网络和连接这些网络的路由器组成，这部分是为边缘部分提供服务的，即连通和数据交换。


**边缘部分的通信方式**

边缘部分的主机相互通信主要有两种方式：

* 客户-服务器 C/S

  客户主机主动发起通信，服务器主机监听特定的端口，收到请求就返回适当的内容。

* 对等连接方式 P2P

  通信两端的主机，不区分客户端与服务端，双方都运行对等的连接软件进行通信。

**核心部分的分组交换**

互联网使用分组交换的方式传输数据。将要发送的整块数据称为一个报文，在发送报文前，先将其划分为一个个更小的数据段，这些数据段称为分组。每个分组的头部会加上一些必要的控制信息，记录分组的源地址、目的地址、数据长度等内容。路由器是分组交换的主要构件，分组通常不会直接点对点传输到目的主机，它会经过一系列路由器。路由器收到分组后，先将其缓存，拆开检查，然后查看路由表，根据目的地址选择合适的路由接口，将分组转发出去。反复执行，直到分组到达目的主机。

分组转发使得相互通信的主机不需要持续维护一条通信线路，只在传输分组的时候才占用通信资源。这还能省去建立连接、释放连接的开销，提高数据的传输效率。

分组交换也带来一些问题：

* 分组在路由器存储转发时需要排队，这会带来一定的时延。
* 每个分组都携带控制信息，这会占用额外的内存。
* 计算机网络不保证分组的可靠交付，端系统需要进行额外的操作以保证通信。

## 网络的体系结构

计算机网络的体系结构是分层次设计的。使用分层，可以将庞大复杂的问题转化为若干较小的局部问题。

计算机网络初始时，许多公司都推出自己的 “网络体系结构”，比如 IBM 的 SNA。这使相同公司生产的设备可以进行通信，但不同公司的设备还是很难连通。

为支持异构网络的互连互通，提出开放系统互连基本参考模型 OSI/RM，以及 TCP/IP 协议。

**OSI**

OSI 由国际标准化组织 ISO 支持建立，但由于多种原因：

* 制定周期较长，期间 TCP/IP 已经占据大部分市场。
* 协议复杂，难以实现。
* 层次划分不合理，有些功能在多个层次重复出现。
* 参与计划的专家没有实际经验，完成 OSI 标准时缺乏商业动力。

导致 OSI 只获得一些理论研究成果，在市场化方面则完全失败。OSI 将网络分为七层，从上到下依次为：应用层、表示层、会话层、运输层、数据链路层、物理层。

**TCP/IP**

相对于 OSI，作为计算机网络事实标准的 TCP/IP 只有四层：应用层、运输层、网络层、网络接口层。

但它的网络接口层并没有具体内容，相当于只有三层。

**五层协议的体系结构**

为完整地学习计算机网络，通常是结合 OSI 和 TCP/IP，学习一种五层的体系结构：

* 应用层

  应用层是最高层，它的任务是通过应用进程间的交互来完成特定的网络应用。应用层的协议规定应用进程间的交互规则。

* 运输层

  负责向两台主机的进程的通信提供通用的数据传输服务，主要有 TCP、UDP 两种协议。通用指不同的网络应用可以使用相同的运输层服务。

* 网络层

  负责为分组交换网上的主机提供通信服务。将运输层的报文段包装成分组，然后选择合适的路由进行传输。

* 数据链路层

  分组交换在网络链路中一段一段的进行，这就需要专门的链路层协议。数据链路层将网络层传输下来的分组包装成帧，帧包含必要的控制信息。

* 物理层

  物理层传输数据的单位是比特，它规定用多大的电压代表 ”1“ 或 “0”、电缆插头的引脚等内容。物理层并不包括电缆、光缆等实际的物理媒体。

# 网络层

重要概念：

* 虚拟互连网络的概念。
* IP 地址和物理地址的关系。
* 传统的分类 IP 地址、子网掩码和无分类域间路由选择 CIDR（超网）。
* 路由选择协议的工作原理。

互联网的网络层向上提供简单的、无连接的、尽最大努力交付的分组服务。

网络在发送分组前不需要预先建立连接，每个分组独立发送，互不相关。网络层不提供服务质量的承诺，分组可能会出错、丢失、重复和失序，也不保证分组的交付时限。如果要求可靠的通信，只能在运输层进行实现。

由于不提供端到端的传输服务，它的实现比较简单，网络造价大大降低，且运行方式灵活，可以适应多种应用。

## 网际协议 IP

网际协议 IP 是网络层唯一使用的协议。通常讨论的都是它的第四个版本 IPv4，现在 IPv6 也逐渐被使用，其它的几个版本从未被使用过。

IP 协议的作用是使互连起来的各种网络能进行通信，由此构建一个虚拟的互连网络。虚拟互连网络就是逻辑上的网络，它的意思是互连起来的各种物理网络的异构性是客观存在的，但我们利用 IP 协议可以使这些网络在网络层上看起来像是统一的。

## IP 地址

IP 地址用于在互联网中唯一标识主机，路由器至少有两个 IP 地址，它用于连接多个网络。

在 IPv4，IP 地址是一串 32 位的标识符。

IP 地址的编址方式经历三个阶段：分类 IP 地址、子网划分、构造超网。

### 分类 IP 地址：二级 IP 地址

所谓分类 IP 地址就是将 IP 地址划分为若干个固定类，其中 A、B、C 三类由两个固定长度的字段组成，第一个字段是网络号（net-id），它标志主机连接到的网络，第二个字段是主机号（host-id），它标志主机。网络号在整个互联网唯一，主机号在单个网络中唯一。A、B、C 三类的区别是网络号、主机号占用的位数不同：

![](https://images-1305875271.cos.ap-chengdu.myqcloud.com/java-55b87ab5.png)

这种两级的 IP 地址可以记为：`IP地址 ::= {<网络号>, <主机号>}`，`::` 的意思是 “定义为”。

将 IP 地址分类，最初是这样考虑的：不同的网络差异很大，有的网络包含很多主机，有的则很少。将 IP 地址分类，当某个单位申请 IP 地址时，实际上是申请某一个网络号的所有 IP 地址，具体的主机号则由单位自行分配。

**点分十进制记法**

为提高可读性，将 IP 地址分为 4 个字节，然后转化为十进制数字，使用 `.` 分隔，比如 `128.168.200.101`。

**IP 保留地址**

在分类的 IP 地址中，全 0 表示 “this” 的意思，全 1 表示 “所有” 的意思。

A 类地址的网络号占 1 个字节，只有 7 位可用。网络号全 0，表示 “本网络”。网络号全 1，即 127，保留作为本地软件环回测试本主机的进程之间的通信之用。若主机发送一个目的地址是环回地址的 IP 数据报，这个数据报会发送回本主机，而不会出现在任何网络上。

A 类地址的主机号占 3 个字节。主机号全 0，表示该 IP 地址是当前主机连接到的单个网络地址。主机号全 1 表示连接到该网络的所有主机。

### 子网划分：三级 IP 地址

所谓子网，是从原始分类 IP 地址的主机号中借用若干位作为子网号，形成一个新的分级。这样就将二级地址转换为三级地址。记为：`IP地址 ::= {<网络号>, <子网号>, <主机号>}`。

子网对外不可见，拥有许多子网的网络对外仍然表现为一个普通网络。数据报根据网络号找到连接在本单位网络的路由器，路由器收到 IP 数据报后，按照目的网络号和子网号找到目的子网，再将数据报传送给目的主机。也就是说，子网的处理，是在本单位网络的路由器上进行的，网络间的传输没有改变。

划分子网可以增加网络的类别，但减少能在网络中分配的主机号。它还能增加网络的灵活性，某单位需要在新的地点开通新的网络，不需要申请新的 IP 地址，只用划分一个新的子网。

**子网掩码**

子网掩码用于确定 IP 地址中哪些位属于网络号、子网号。子网掩码有 32 位，表示网络号和子网号的位值为 1，主机号值为 0。将子网掩码与 IP 地址进行与运算就能得到子网号。比如二级 IP 地址 `127.128.200.101`，它使用第 3 个字节表示子网号，子网掩码为 `127.128.200.0`。

子网掩码已成为互联网的正式标准。如果没有划分子网，子网掩码还有什么作用呢？它能加速查找路由表。互联网标准规定：所有网络都必须使用子网掩码。如果一个网络没有划分子网，那么该网络使用默认子网掩码。使用默认子网掩码与 IP 地址进行与运算，能直接得到网络号，而不用专门查看 IP 地址的类别位。

### 构造超网：两级 IP 地址

超网用于解决两个问题：B 类地址即将用尽、互联网主干网的路由表的项目急剧增长。

超网重新将 IP 地址分为二级地址，前段是可变长的网络前缀，后段为主机号。其实就是将分类 IP 地址中的网络号化为可变长字段。记为：`IP地址 ::= {<网络前缀>, <主机号>}`。

这样就可以为剩余的 IP 地址划分大量的网络，从而提高 IP 地址的利用率。

超网使用变长子网掩码确定网络前缀，原理和子网掩码相同。

超网使用斜线记法，在 IP 地址后面写上网络前缀占用的位数，比如 `128.168.200.101/16`。

超网不使用子网，这是指超网的 IP 地址没有专门借用位标识子网号。但在超网内部，依然可以划分子网，子网 IP 地址的前缀是超网前缀的拓展。

**超网如何减少路由表项目？**

超网可以使用一个简短的前缀，囊括大量的网络地址，从而压缩路由器的网络路由表。这能减少路由器之间的路由信息交换，提高互联网的性能。

**最长前缀匹配**

路由器在匹配超网地址时，如果有多个匹配的项目，选择具有最长网络前缀的路由。因为网络前缀越长，其地址块就越小，路由就越精确。

## 硬件地址和 ARP 协议

IP 地址不管怎样，始终只是逻辑上的标识符，它依靠软件和互联网运行。而每台主机其实也有自己唯一的物理标识：绑定在硬件的硬件地址，也称为 MAC 地址。

数据链剧层传输网络层的数据时，会将 IP 数据报包装成帧，帧的头部也有类似源地址、目的地址的信息，不过这里不再是 IP 地址，而是 MAC 地址。数据报的 IP 地址在传输中始终不会改变，而帧每次分组转发时都要进行拆包和重装，并更新 MAC 地址。

**ARP 协议**

ARP 协议用于根据 IP 地址获取匹配的 MAC 地址。每台主机都有 ARP 高速缓存，其中存储当前网络中各主机 IP 地址与 MAC 地址的映射。

初始时，ARP 高速缓存还没有任何映射，当需要获取某个 IP 地址对应的 MAC 地址时，主机会向当前局域网的所有主机发送 ARP 请求分组，其中包含请求的 IP 地址。收到请求的主机会查看请求分组中的 IP 地址，并于自己进行对比，如果不同，则忽略这个请求。否则将返回一个 ARP 响应，其中包含请求的映射。

如果每次要获取一个新映射都要给所有主机发送 ARP 请求，太影响效率。主机发送的请求分组会包含自己的 IP 地址与 MAC 地址的映射，收到请求的主机将会缓存该映射，以减少后续的 ARP 请求。

**为什么不直接使用 MAC 地址作为网络通信的地址呢？**

IP 地址的好处在于：所有 IP 网络中的主机，都有统一格式的标识符。而对于硬件地址，不同的生产商有不同的标准，要使用这些异构的 MAC 地址进行通信就不得不进行复杂的地址转换工作，效率太低。

## 补充：路由表构造、路由流程

TODO：有空看完书再写。

# 传输层

重要概念：

* 运输层为相互通信的应用进程提供逻辑通信。
* 端口和套接字的意义。
* 无连接的 UDP 的特点。
* 面向连接的 TCP 的特点。
* 在不可靠的网络上实现可靠传输的工作原理，停止等待协议和 ARQ 协议。
* TCP 的滑动窗口、流量控制、拥塞控制和连接管理。

## 进程间的通信

运输车向上面的应用层提供通信服务，网络核心部分在转发分组时只使用到下三层的功能，只有边缘部分的主机的协议栈才有运输层。

**IP 协议已经能按照首部的目标地址，将分组传送到目的主机，那为什么还需要运输层呢？**

从 IP 层看，通信的两端是两台主机，IP 数据报的首部明确标志源主机和目的主机的 IP 地址。但真正进行通信的，其实是两台主机中的进程。如果只将分组传送到目的主机，而不指明它被哪个进程所使用，那又有什么意义呢？运输层的作用，就是将网络层的数据，交付给特定的应用进程。

**复用与分用**

复用指在发送方的不同应用进程，可以使用同一个运输层协议传送数据。当然，需要加上适当的首部。

分用指接收方的运输层在拆开报文的首部后能将这些数据正确交付到不同的目的应用进程。

**逻辑通信**

运输层将下层的所有复杂逻辑都屏蔽掉，为应用进程提供逻辑通信。所谓逻辑通信，指从应用层的角度来看，只要把数据交给运输层，数据就能直接传输到目的主机的运输层，好像运输层间有一条端到端的信道一样。

## 运输层的端口

如何在主机中唯一标识一个应用进程，以让运输层能选择正确的目标？

操作系统使用进程标识符标志进程，但互联网不能直接使用这个标志，因为不同操作系统的标识符格式可能不同。这时可以联想到 IP 地址与 MAC 地址。

直接标识某台主机的某个进程，这并不好，因为进程的创建和撤销是动态的，通信的一端几乎无法识别另一端的进程。另外，我们关注的其实是主机提供的某种功能，而不需要知道具体是由哪一个进程实现的。TCP/IP 使用协议端口解决这个问题，通信的终点虽然是应用进程，但只需将报文传输到特定的端口，后面的工作则交给 TCP/UDP 来完成。

现在，从运输层的角度来看，源和目的地，不但包括 IP 地址，还有端口。端口是互联网实现的功能，它与操作系统无关。

TCP/IP 的运输层使用一个 16 位的端口号标志一个端口，端口号只有本地意义，它只用于标志本计算机应用层中的各个进程在和运输层交互时的层间接口。不同计算机的相同端口号没有任何关联。

> **对端口的个人理解**
>
> 指定应用进程占用某个端口号，运输层收到数据报后，拆包获取控制信息，将数据传送到指定的端口。占用这个端口的进程，就会接收到这些数据。

## UDP

UDP 传输的分组称为用户数据报，它只在 IP 数据报的服务之上增加很少的功能，就是复用、分用以及差错检测的功能。UDP 的特点是：

* UDP 是无连接的。发送数据前不需要建立连接，因此减少了开销和发送数据前的时延。
* UDP 使用尽最大努力交付，不保证可靠交付，因此主机不需要维护复杂的连接状态表。
* UDP 是面向报文的。发送方的 UDP 对应用层交下来的报文，既不合并也不拆分，在添加首部后就直接交付到 IP 层。接收方的 UDP 对 IP 层交上来的 UDP 用户数据报，去除首部后就原封不动地交给应用层。也就是说，UDP 一次交付一个完整的报文，因此应用程序应该选择合适大小的报文。若报文太长，IP 层就需要进行分片，这会降低 IP 层的效率。若太短，又会使 IP 数据报的首部相对长度太大，降低 IP 的传输效率。
* UDP 没有拥塞控制，所以就算网络出现拥塞，UDP 发送数据报的速率也不会降低。
* UDP 支持一对一、一对多、多对多的交互通信。
* DUP 首部开销很小，只有 8 个字节，由四个字段组成：源端口、目的端口、UDP 用户数据报长度、校验和。

当 UDP 从 IP 层收到用户数据报时，就根据首部中的目的端口，把数据通过相应的端口交付给最终的进程。如果 UDP 发现报文中的目的端口不正确，则丢弃该报文，并由网际控制报文协议 ICMP 返回差错报文 “端口不可达” 给发送方。

注意，虽然 UDP 的首部也包含端口信息，但 UDP 的通信是无连接的，因此不需要使用 TCP 中的套接字 socket 来建立连接。

UDP 用户数据报首部的校验和，计算方式与 IP 数据报的校验和相似。但它在计算时会在首部临时加一个伪首部，其中包含字段：源 IP 地址、目的 IP 地址等。UDP 的校验和会把伪首部、首部以及数据部分一齐进行校验。所以，UDP 的校验和会检查源端口、目的端口、数据部分、源 IP 地址和目的 IP 地址。

## TCP

### 概述

UDP 传输的分组称为 TCP 报文段，相对于 UDP，它非常复杂。TCP 的特点是：

* TCP 是面向连接的。应用进程在使用 TCP 协议之前，必须先建立 TCP 连接。在传输数据完毕后，必须释放 TCP 连接。
* TCP 只支持一对一的通信。
* TCP 提供可靠交付的服务。通过 TCP 传输的数据，能够无差错、不丢失、不重复，并且按序达到。
* TCP 提供双全工通信。TCP 连接的两端即是发送方也是接收方，它们可以在任何时候向对方发送数据。TCP 连接的两端都设有发送缓存和接收缓存，用来临时存放通信数据。发送时，把数据传入发送缓存后就可以直接返回。接收时，把收到的数据放入接收缓存，上层应用会在合适的时候读取缓存数据。
* TCP 是面向字节流的。流指的是流入进程或流出进程的字节序列。面向字节流指：虽然应用进程和 TCP 是通过数据块交互，但 TCP 只把应用层交下来的数据看作一连串无结构的字节流，TCP 并不知道所传输字节流的含义。而且由于 TCP 的缓存，接收方应用程序收到的数据块和发送方应用程序发出的数据块没有对应关系。如果发送的数据块太小，TCP 先将其放在缓存，等待累计足够多的字节再发送。如果数据块过大，TCP 就将它划分短一些再传送。但字节流的内容却是完全一致的。至于每次每个报文段应该包含多少字节，这是由通信另一方给出的窗口值和当前网络的拥塞程度所决定的。

### 套接字 socket

TCP 将连接作为最基本的抽象，每条 TCP 连接都有两个端点。TCP 使用套接字定义连接的端点，端口号拼接到 IP 地址就是套接字，记为 `套接字 socket = (IP地址: 端口号)`。

每条 TCP 连接由两端的套接字所确定，记为 `TCP连接 ::= {(IP1: port1), (IP2: port2)}`。
